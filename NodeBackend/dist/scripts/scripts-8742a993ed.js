"use strict";angular.module("menuApp",["ngMaterial","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ui.router","vcRecaptcha"]).config(["$stateProvider","$urlRouterProvider","$sceDelegateProvider",function(e,t,r){t.otherwise("/cart"),e.state("root",{url:"",templateUrl:"views/mainView.html",controller:"mainController",controllerAs:"vm",abstract:!0}).state("root.cart",{url:"/cart",templateUrl:"views/cartView.html",controller:"cartController",controllerAs:"vm"}).state("root.history",{url:"/history",templateUrl:"views/historyView.html",controller:"historyController",controllerAs:"vm"}),r.resourceUrlWhitelist(["self","http://localhost:5000/**"])}]),angular.module("menuApp").factory("httpService",["$http",function(e){return{backendAddress:"http://localhost:5000",getDish:function(t){return e({url:this.backendAddress+"/api/getDish?dishId="+t,method:"GET"}).then(function(e){return e},function(e){return e})},retrieveHistory:function(t){return e({url:this.backendAddress+"/api/retrieveHistory",method:"POST",data:t,headers:{"Content-Type":"application/json"}}).then(function(e){return e},function(e){return e})},sendOrder:function(t){return e({url:this.backendAddress+"/api/sendOrder",method:"POST",data:t,headers:{"Content-Type":"application/json"}}).then(function(e){return e},function(e){return e})},requestAuthentication:function(t){return e({url:this.backendAddress+"/api/requestAuthentication",method:"POST",data:t,headers:{"Content-Type":"application/json"}}).then(function(e){return e},function(e){return e})},resetPassword:function(t){return e({url:this.backendAddress+"/api/resetPassword",method:"POST",data:t,headers:{"Content-Type":"application/json"}}).then(function(e){return e},function(e){return e})}}}]),angular.module("menuApp").factory("stateShareService",function(){return{order:[],historyRetrieved:!1,history:{},expandLatest:!1}}),angular.module("menuApp").config(["$sceDelegateProvider",function(e){e.resourceUrlWhitelist(["self","http://localhost:5000/**"])}]),angular.module("menuApp").controller("cartController",["httpService","stateShareService","$mdDialog",function(e,t,r){var o=this;o.basketPrice=0,o.basket=t.order,o.addDish=function(t){e.getDish(t).then(function(e){if(e.data.err)window.alert(e.data.err);else{var t=e.data.rows,r=t[0],n=!1;o.basket.forEach(function(e){e.itemID==r.key&&(e.count+=1,o.basketPrice=(parseFloat(o.basketPrice)+parseFloat(r.value[1])).toFixed(2),n=!0)}),n||(o.basketPrice=(parseFloat(o.basketPrice)+parseFloat(r.value[1])).toFixed(2),o.basket.push({name:r.value[0],itemID:r.key,price:r.value[1],count:1}))}})},o.removeDishSingle=function(e){var t=o.basket.indexOf(e);o.basket[t].count-=1,0===o.basket[t].count&&o.basket.splice(t,1),o.basketPrice=(parseFloat(o.basketPrice)-parseFloat(e.price)).toFixed(2)},o.removeDishAll=function(e){var t=o.basket.indexOf(e);o.basketPrice=(parseFloat(o.basketPrice)-parseFloat(parseFloat(e.price)*e.count)).toFixed(2),o.basket[t].count=0,o.basket.splice(t,1)},o.sendOrder=function(){for(var t=[],r=0;r<o.basket.length;r++)t.push({count:o.basket[r].count,dish:o.basket[r].itemID,price:o.basket[r].price,name:o.basket[r].name});var n=angular.toJson({dishes:t,total:o.basketPrice,phoneNumber:"860401485"});e.sendOrder(n).then(function(e){e.data.err?window.alert("Can't find DB."):(o.basketPrice=0,o.basket.splice(0,o.basket.length))})},o.showPrompt=function(){if(0==o.basket.length)return void window.alert("Cart is empty!");r.show({controller:"cartAuthController",templateUrl:"views/extra/cartAuthDialogView.html"})}}]),angular.module("menuApp").controller("historyController",["httpService","stateShareService","$mdDialog",function(e,t,r){var o=this;o.history=t.history,o.historyRetrieved=t.historyRetrieved,o.authPhoneNumber="",o.authPassword="",o.toggleOrder=function(e){for(var t=0;t<o.history.length;t++)o.history[t].expanded=t===e&&!o.history[t].expanded},o.setRetrieved=function(){o.historyRetrieved=!o.historyRetrieved,t.historyRetrieved=o.historyRetrieved},o.retrieveHistory=function(){o.history=[];var t={phoneNumber:o.authPhoneNumber,password:o.authPassword};e.retrieveHistory(t).then(function(e){if(e.data.err)return void window.alert(e.data.err);o.history=e.data.orders,o.setRetrieved()})},o.showPrompt=function(){r.show({controller:"passwordResetController",templateUrl:"views/extra/passwordResetDialogView.html"})}}]),angular.module("menuApp").controller("cartAuthController",["$scope","$mdDialog","$state","vcRecaptchaService","httpService","stateShareService",function(e,t,r,o,n,i){e.siteKey="6LdCmh0UAAAAAOCCmuEpb8C0edrrl6kgl3x7MBJ0",e.phoneNumber=null,e.phoneCode=null,e.response=null,e.widgetId=null,e.showPhone=!0,e.showCode=!1,e.changeState=function(){e.showPhone=e.showCode,e.showCode=!e.showPhone},e.closeDialog=function(){t.hide()},e.setWidgetId=function(t){e.widgetId=t},e.setResponse=function(t){e.response=t},e.cbExpiration=function(){o.reload(e.widgetId),e.response=null},e.requestCode=function(){var t={phoneNumber:e.phoneNumber,recaptcha:e.response};n.requestAuthentication(t).then(function(t){e.changeState()})},e.sendOrder=function(){var o={phoneCode:e.phoneCode,order:i.order,phoneNumber:e.phoneNumber};n.sendOrder(o).then(function(e){e.data.orders.length>0&&(t.hide(),i.history=e.data.orders,i.historyRetrieved=!0,i.expandLatest=!0,r.go("root.history"))})}}]),angular.module("menuApp").directive("cartItemDirective",function(){return{scope:{imageLink:"@",title:"@",count:"@",price:"@",removeFn:"&",addFn:"&",removeAllFn:"&"},templateUrl:"views/directives/cartItemDirective.html",link:function(e,t,r){e.imageLink=r.imagelink,e.parsePrice=function(){return parseFloat(parseFloat(e.price)*e.count).toFixed(2)}}}}),angular.module("menuApp").directive("orderItemDirective",function(){return{scope:{imageLink:"@",title:"@",count:"@",price:"@"},templateUrl:"views/directives/orderItemDirective.html",link:function(e,t,r){e.imageLink=r.imagelink,e.parsePrice=function(){return parseFloat(parseFloat(e.price)*e.count).toFixed(2)}}}}),angular.module("menuApp").controller("mainController",["$rootScope","$scope","stateShareService","$state",function(e,t,r,o){var n=this;n.state="cart",t.$on("stateChange",function(e,t){n.state=t})}]),angular.module("menuApp").controller("passwordResetController",["$scope","$mdDialog","vcRecaptchaService","httpService","stateShareService",function(e,t,r,o,n){e.siteKey="6LdCmh0UAAAAAOCCmuEpb8C0edrrl6kgl3x7MBJ0",e.phoneNumber=null,e.response=null,e.widgetId=null,e.closeDialog=function(){t.hide()},e.setWidgetId=function(t){e.widgetId=t},e.setResponse=function(t){e.response=t},e.cbExpiration=function(){r.reload(e.widgetId),e.response=null},e.resetPassword=function(){var t={phoneNumber:e.phoneNumber,recaptcha:e.response};o.resetPassword(t).then(function(t){e.closeDialog()})}}]);